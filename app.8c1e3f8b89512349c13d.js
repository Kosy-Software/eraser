(()=>{"use strict";(()=>{function e(e){let s=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0),t=s.querySelector("iframe");return t.style.height="100vh",t.style.width="100vw",t.src="https://app.tryeraser.com",s}class s{constructor(e){this.kosyClient=window.parent,this.latestMessageNumber=0,this.kosyApp=e}dictionaryToArray(e){let s=[];for(const t in e)e.hasOwnProperty(t)&&s.push([t,e[t]]);return s}startApp(){return this.initialInfoPromise=new Promise(((e,s)=>{window.addEventListener("message",(s=>{let t=s.data;switch(t.type){case"receive-initial-info":this.latestMessageNumber=t.latestMessageNumber,this.clients=t.payload.clients,this.hostClientUuid=t.payload.initializerClientUuid,this.log("Resolving initial info promise with: ",t.payload),e(t.payload);break;case"set-client-info":{let e=t.clients,s=t.hostClientUuid;this.initialInfoPromise.then((i=>{let n=this.dictionaryToArray(e).filter((e=>!this.clients[e[0]])),a=this.dictionaryToArray(this.clients).filter((s=>!e[s[0]])),o=this.latestMessageNumber;s!==this.hostClientUuid&&"function"==typeof this.kosyApp.onHostHasChanged&&(this.log("On host has changed was defined -> notifying everyone the host has changed",t),this._relayMessageToClients(i,{type:"_host-has-changed",clientUuid:s},++o)),n.length>0&&"function"==typeof this.kosyApp.onClientHasJoined&&(this.log("On client has joined was defined",t),n.forEach((e=>this._relayMessageToClients(i,{type:"_client-has-joined",clientInfo:e[1]},++o)))),a.length>0&&"function"==typeof this.kosyApp.onClientHasLeft&&(this.log("On client has left was defined",t),a.forEach((e=>this._relayMessageToClients(i,{type:"_client-has-left",clientUuid:e[0]},++o)))),this.clients=e,this.hostClientUuid=s}));break}case"get-app-state":{let e=t.clientUuids;this.log("Get app state received -> sending app state");const s=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",state:s,clientUuids:e,latestMessageNumber:this.latestMessageNumber});break}case"set-app-state":this.latestMessageNumber=t.latestMessageNumber;let s=t.state;this.initialInfoPromise.then((()=>{this.log("Received app state from Kosy -> setting app state"),this.kosyApp.onProvideState(s)}));break;case"receive-message-as-host":this._handleReceiveMessageAsHost(t);break;case"receive-message-as-client":this._handleReceiveMessageAsClient(t)}})),this._sendMessageToKosy({type:"ready-and-listening"})})),this.initialInfoPromise}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this.log("Relaying client message to host: ",e),this._sendMessageToKosy({type:"relay-message-to-host",message:e})}_relayMessageToClients(e,s,t){this.log("Relaying host to client message: ",s),this._sendMessageToKosy({type:"relay-message-to-clients",sentByClientUuid:e.currentClientUuid,message:s,messageNumber:t})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}_handleReceiveMessageAsClientRecursive(e,s,t){var i,n,a,o,l,r;if(this.latestMessageNumber===e.messageNumber-1){switch(e.message.type){case"_host-has-changed":null===(n=(i=this.kosyApp).onHostHasChanged)||void 0===n||n.call(i,e.message.clientUuid);break;case"_client-has-joined":null===(o=(a=this.kosyApp).onClientHasJoined)||void 0===o||o.call(a,e.message.clientInfo);break;case"_client-has-left":null===(r=(l=this.kosyApp).onClientHasLeft)||void 0===r||r.call(l,e.message.clientUuid);break;default:this.kosyApp.onReceiveMessageAsClient(e.message)}this.latestMessageNumber=e.messageNumber}else t<50&&this.latestMessageNumber<e.messageNumber?setTimeout((()=>this._handleReceiveMessageAsClientRecursive(e,s,t+1)),100):(this.log("Timeout on processing message as client: ",e.message),this.log("Wait for Kosy to fix this mess..."))}_handleReceiveMessageAsClient(e){this.initialInfoPromise.then((s=>{this.log("Received message as client, processing: ",e.message),this._handleReceiveMessageAsClientRecursive(e,s,0)}))}_handleReceiveMessageAsHost(e){this.initialInfoPromise.then((s=>{this.log("Trying to handle message as host");const t=this.kosyApp.onReceiveMessageAsHost(e.message);t&&this._relayMessageToClients(s,t,this.latestMessageNumber+1)}))}log(...e){"1"===localStorage.getItem("debug-mode")&&console.log("From kosy-app-api: ",...e)}}var t;!function(t){var i;(function(t){class i{constructor(){this.state={},this.kosyApi=new s({onReceiveMessageAsClient:e=>this.processMessage(e),onReceiveMessageAsHost:e=>e,onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e,s,t,i,n;return s=this,t=void 0,n=function*(){let s=yield this.kosyApi.startApp();this.initializer=s.clients[s.initializerClientUuid],this.currentClient=s.clients[s.currentClientUuid],this.state=null!==(e=s.currentAppState)&&void 0!==e?e:this.state,this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))},new((i=void 0)||(i=Promise))((function(e,a){function o(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(s){var t;s.done?e(s.value):(t=s.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,l)}r((n=n.apply(s,t||[])).next())}))}setState(e){this.state=e,this.renderComponent()}getState(){return this.state}processMessage(e){e.type}processComponentMessage(e){e.type}renderComponent(){!function(s){let t,i=document.getElementById("root");t=e;var n=i.cloneNode(!1);i.parentNode.replaceChild(n,i),n.appendChild(t(s))}({currentClient:this.currentClient,initializer:this.initializer})}log(...e){var s,t;console.log(`${null!==(t=null===(s=this.currentClient)||void 0===s?void 0:s.clientName)&&void 0!==t?t:"New user"} logged: `,...e)}}t.App=i,(new i).start()})((i=t.Integration||(t.Integration={})).Witeboard||(i.Witeboard={}))}(t||(t={}))})()})();